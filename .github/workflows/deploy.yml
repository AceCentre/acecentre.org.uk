name: Deploy and Test
on:
  workflow_dispatch:
  pull_request: # REMOVE ME
  push:
    branches:
      - main
  # schedule:
  #   - cron: "0 2,8,1,17 * * *"

concurrency:
  group: deploy-${{ github.head_ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  Jest:
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Install NPM deps
        run: yarn install

      - name: Run Jest Tests
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: yarn test

  BuildIntegrationOnDigitalOcean:
    needs: [Jest]
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Create deployment
        run: doctl apps create-deployment 64e56aae-8e76-4055-8196-38561f2264e0 --wait

  CypressIntegration:
    needs: [BuildIntegrationOnDigitalOcean]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  BuildProductionOnDigitalOcean:
    needs: [CypressIntegration]
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Create deployment
        run: doctl apps create-deployment 67b77fd5-aa83-400f-8572-e73c52dc3aca --wait

  CypressProduction:
    runs-on: ubuntu-latest
    needs: [BuildProductionOnDigitalOcean]
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunOnePost:
    runs-on: ubuntu-latest
    needs: [CypressProduction]
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunTwoPost:
    needs: [GauntletRunOnePost]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunThreePost:
    needs: [GauntletRunTwoPost]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunFourPost:
    needs: [GauntletRunThreePost]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunFivePost:
    needs: [GauntletRunFourPost]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: post-deploy
      BASE_URL: https://production.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunOnePre:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunTwoPre:
    needs: [GauntletRunOnePre]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunThreePre:
    needs: [GauntletRunTwoPre]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunFourPre:
    needs: [GauntletRunThreePre]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5

  GauntletRunFivePre:
    needs: [GauntletRunFourPre]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    env:
      CYPRESS_INCLUDE_TAGS: pre-deploy
      BASE_URL: https://integration.acecentre.org.uk

    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Cypress run
        with:
          config: baseUrl=$BASE_URL,retries=0
          record: true
          install: true
          parallel: true
          browser: chrome
        env:
          CYPRESS_MOODLE_USERNAME: ${{ secrets.CYPRESS_MOODLE_USERNAME }}
          CYPRESS_MOODLE_PASSWORD: ${{ secrets.CYPRESS_MOODLE_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CYPRESS_WORDPRESS_AUTH: ${{ secrets.WORDPRESS_AUTH }}
          CYPRESS_MOODLE_AUTH: ${{ secrets.CYPRESS_MOODLE_AUTH }}
        uses: cypress-io/github-action@v5
